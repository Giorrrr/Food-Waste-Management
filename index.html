<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Food Waste Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            margin-top: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-top: 10px;
        }

        .stat-card.total h3 {
            color: #667eea;
        }

        .stat-card.critical h3 {
            color: #f59e0b;
        }

        .stat-card.expired h3 {
            color: #ef4444;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-purple {
            background: #764ba2;
            color: white;
        }

        .btn-purple:hover {
            background: #643a8f;
        }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .products-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .product-card {
            border: 3px solid;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: transform 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-card.safe {
            background: #d1fae5;
            border-color: #10b981;
        }

        .product-card.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .product-card.critical {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .product-card.expired {
            background: #fecaca;
            border-color: #dc2626;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .product-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-title h3 {
            font-size: 1.5em;
            color: #333;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .badge.safe {
            background: #10b981;
        }

        .badge.warning {
            background: #f59e0b;
        }

        .badge.critical {
            background: #ef4444;
        }

        .badge.expired {
            background: #dc2626;
        }

        .product-actions {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        .btn-ai {
            background: #8b5cf6;
            color: white;
        }

        .btn-edit {
            background: #3b82f6;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        .product-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .alert-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .alert-box.critical {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .alert-box p {
            margin-top: 5px;
            color: #333;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #f3e7ff 0%, #e9d5ff 100%);
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .ai-suggestion.active {
            display: block;
        }

        .ai-suggestion h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #333;
        }

        .ai-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            line-height: 1.8;
            font-size: 15px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .ai-content h3 {
            color: #667eea;
            font-size: 1.3em;
            margin-top: 20px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .ai-content h3:first-child {
            margin-top: 0;
        }

        .ai-content p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .ai-content ul,
        .ai-content ol {
            margin: 15px 0;
            padding-left: 25px;
        }

        .ai-content li {
            margin-bottom: 12px;
            line-height: 1.7;
            position: relative;
        }

        .ai-content strong {
            color: #764ba2;
            font-weight: 700;
        }

        .ai-content em {
            color: #667eea;
            font-style: italic;
        }

        .ai-recommendation {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
        }

        .ai-recommendation-item {
            background: white;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #764ba2;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .ai-recommendation-item strong {
            display: block;
            color: #764ba2;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .video-container {
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .video-container h3 {
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-links {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .video-link-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 18px 24px;
            border-radius: 12px;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .video-link-card:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .video-link-card a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .video-icon {
            background: white;
            color: #667eea;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .video-arrow {
            color: white;
            font-size: 24px;
            flex-shrink: 0;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .actions {
                flex-direction: column;
            }

            .product-header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üõí Food Waste Manager</h1>
                <p>Supermarket Inventory & AI-Powered Solutions</p>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card total">
                <div>
                    <p>Total Produk</p>
                    <h3 id="totalProducts">0</h3>
                </div>
                <span style="font-size: 3em">üì¶</span>
            </div>
            <div class="stat-card critical">
                <div>
                    <p>Segera Expired</p>
                    <h3 id="criticalProducts">0</h3>
                </div>
                <span style="font-size: 3em">‚ö†Ô∏è</span>
            </div>
            <div class="stat-card expired">
                <div>
                    <p>Sudah Expired</p>
                    <h3 id="expiredProducts">0</h3>
                </div>
                <span style="font-size: 3em">‚ùå</span>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="toggleForm()">‚ûï Tambah Produk</button>
            <button class="btn btn-purple" onclick="toggleApiKey()">‚ú® <span id="apiKeyBtnText">Setup API
                    Key</span></button>
        </div>

        <div class="form-container" id="apiKeyForm">
            <h2>üîë Setup Gemini API Key</h2>
            <p style="margin: 15px 0; color: #666">Dapatkan API Key gratis di: <a
                    href="https://makersuite.google.com/app/apikey" target="_blank" style="color: #667eea">Google AI
                    Studio</a></p>
            <div style="display: flex; gap: 10px">
                <input type="password" id="apiKeyInput" placeholder="Masukkan API Key Gemini"
                    style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px" />
                <button class="btn btn-primary" onclick="saveApiKey()">Simpan</button>
                <button class="btn" style="background: #e5e7eb" onclick="toggleApiKey()">Batal</button>
            </div>
        </div>

        <div class="form-container" id="productForm">
            <h2 id="formTitle">‚ûï Tambah Produk Baru</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nama Produk *</label>
                    <input type="text" id="productName" placeholder="Contoh: Susu Full Cream" required />
                </div>
                <div class="form-group">
                    <label>Kategori *</label>
                    <select id="productCategory">
                        <option>Dairy</option>
                        <option>Meat</option>
                        <option>Vegetables</option>
                        <option>Fruits</option>
                        <option>Bakery</option>
                        <option>Beverages</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Jumlah (unit) *</label>
                    <input type="number" id="productQuantity" placeholder="50" required />
                </div>
                <div class="form-group">
                    <label>Tanggal Expired *</label>
                    <input type="date" id="productExpiry" required />
                </div>
                <div class="form-group">
                    <label>Harga (Rp) *</label>
                    <input type="number" id="productPrice" placeholder="25000" required />
                </div>
                <div class="form-group">
                    <label>Lokasi/Rak *</label>
                    <input type="text" id="productLocation" placeholder="Rak A-12" required />
                </div>
            </div>
            <div style="display: flex; gap: 15px">
                <button class="btn btn-primary" onclick="saveProduct()" style="flex: 1">üíæ <span id="saveBtnText">Simpan
                        Produk</span></button>
                <button class="btn" style="background: #e5e7eb" onclick="cancelForm()">‚ùå Batal</button>
            </div>
        </div>

        <div class="products-container">
            <h2 style="margin-bottom: 20px">üìã Daftar Produk</h2>
            <div id="productsList"></div>
        </div>

        <div class="ai-suggestion" id="aiSuggestion">
            <h2>‚ú® Saran AI - Gemini</h2>
            <div class="ai-content" id="aiContent"></div>
            <div class="video-container" id="videoContainer" style="display: none">
                <h3>üé• Cari Video Tutorial di YouTube</h3>
                <p style="color: #666; margin-bottom: 15px">Klik untuk mencari video tutorial yang relevan:</p>
                <div class="video-links" id="videoLinks"></div>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let editingId = null;
        let apiKey = "";

        function init() {
            const saved = localStorage.getItem("foodProducts");
            if (saved) {
                products = JSON.parse(saved);
            }
            const savedKey = localStorage.getItem("geminiApiKey");
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById("apiKeyBtnText").textContent = "Update API Key";
            }
            renderProducts();
            updateStats();
        }

        function saveToLocalStorage() {
            localStorage.setItem("foodProducts", JSON.stringify(products));
        }

        function toggleForm() {
            const form = document.getElementById("productForm");
            form.classList.toggle("active");
            if (!form.classList.contains("active")) {
                cancelForm();
            }
        }

        function toggleApiKey() {
            const form = document.getElementById("apiKeyForm");
            form.classList.toggle("active");
            if (form.classList.contains("active")) {
                document.getElementById("apiKeyInput").value = apiKey;
            }
        }

        function saveApiKey() {
            const key = document.getElementById("apiKeyInput").value.trim();
            if (!key) {
                alert("Masukkan API Key terlebih dahulu!");
                return;
            }
            apiKey = key;
            localStorage.setItem("geminiApiKey", apiKey);
            document.getElementById("apiKeyBtnText").textContent = "Update API Key";
            toggleApiKey();
            alert("‚úÖ API Key berhasil disimpan!");
        }

        function cancelForm() {
            editingId = null;
            document.getElementById("productName").value = "";
            document.getElementById("productCategory").value = "Dairy";
            document.getElementById("productQuantity").value = "";
            document.getElementById("productExpiry").value = "";
            document.getElementById("productPrice").value = "";
            document.getElementById("productLocation").value = "";
            document.getElementById("formTitle").textContent = "‚ûï Tambah Produk Baru";
            document.getElementById("saveBtnText").textContent = "Simpan Produk";
            document.getElementById("productForm").classList.remove("active");
        }

        function saveProduct() {
            const name = document.getElementById("productName").value.trim();
            const category = document.getElementById("productCategory").value;
            const quantity = document.getElementById("productQuantity").value;
            const expiryDate = document.getElementById("productExpiry").value;
            const price = document.getElementById("productPrice").value;
            const location = document.getElementById("productLocation").value.trim();

            if (!name || !quantity || !expiryDate || !price || !location) {
                alert("‚ö†Ô∏è Mohon lengkapi semua field!");
                return;
            }

            const product = {
                id: editingId || Date.now(),
                name,
                category,
                quantity,
                expiryDate,
                price,
                location,
            };

            if (editingId) {
                products = products.map((p) => (p.id === editingId ? product : p));
            } else {
                products.push(product);
            }

            saveToLocalStorage();
            renderProducts();
            updateStats();
            cancelForm();
            alert(editingId ? "‚úÖ Produk berhasil diupdate!" : "‚úÖ Produk berhasil ditambahkan!");
        }

        function editProduct(id) {
            const product = products.find((p) => p.id === id);
            if (!product) return;

            editingId = id;
            document.getElementById("productName").value = product.name;
            document.getElementById("productCategory").value = product.category;
            document.getElementById("productQuantity").value = product.quantity;
            document.getElementById("productExpiry").value = product.expiryDate;
            document.getElementById("productPrice").value = product.price;
            document.getElementById("productLocation").value = product.location;
            document.getElementById("formTitle").textContent = "‚úèÔ∏è Edit Produk";
            document.getElementById("saveBtnText").textContent = "Update Produk";
            document.getElementById("productForm").classList.add("active");
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function deleteProduct(id) {
            if (!confirm("‚ùå Apakah Anda yakin ingin menghapus produk ini?")) return;
            products = products.filter((p) => p.id !== id);
            saveToLocalStorage();
            renderProducts();
            updateStats();
            alert("‚úÖ Produk berhasil dihapus!");
        }

        function getDaysUntilExpiry(expiryDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiry = new Date(expiryDate);
            expiry.setHours(0, 0, 0, 0);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getUrgencyLevel(days) {
            if (days < 0) return { level: "expired", label: "EXPIRED", color: "expired" };
            if (days === 0) return { level: "critical", label: "HARI INI", color: "critical" };
            if (days <= 2) return { level: "critical", label: `${days} hari lagi`, color: "critical" };
            if (days <= 5) return { level: "warning", label: `${days} hari lagi`, color: "warning" };
            return { level: "safe", label: `${days} hari lagi`, color: "safe" };
        }

        function getAlertMessage(days) {
            if (days < 0) return `üî¥ Produk sudah EXPIRED ${Math.abs(days)} hari yang lalu! Segera buang atau donasikan jika masih layak.`;
            if (days === 0) return "üî¥ Produk expired HARI INI! Segera lakukan diskon besar atau donasi.";
            if (days === 1) return "üü† Produk expired BESOK! Pertimbangkan diskon 50% atau bundling produk.";
            if (days === 2) return "üü° Expired dalam 2 hari. Mulai diskon 30-40% atau buat promo khusus.";
            if (days <= 5) return `üü° Expired dalam ${days} hari. Pertimbangkan diskon 20% atau program loyalitas.`;
            return "";
        }

        function renderProducts() {
            const container = document.getElementById("productsList");

            if (products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 4em;">üì¶</p>
                        <p style="font-size: 1.2em;">Belum ada produk</p>
                        <p>Tambahkan produk pertama Anda!</p>
                    </div>
                `;
                return;
            }

            const sorted = [...products].sort((a, b) => getDaysUntilExpiry(a.expiryDate) - getDaysUntilExpiry(b.expiryDate));

            container.innerHTML = sorted
                .map((product) => {
                    const daysLeft = getDaysUntilExpiry(product.expiryDate);
                    const urgency = getUrgencyLevel(daysLeft);
                    const alertMsg = getAlertMessage(daysLeft);
                    const expiryDateFormatted = new Date(product.expiryDate).toLocaleDateString("id-ID", {
                        day: "numeric",
                        month: "long",
                        year: "numeric",
                    });

                    return `
                    <div class="product-card ${urgency.color}">
                        <div class="product-header">
                            <div class="product-title">
                                <h3>${product.name}</h3>
                                <span class="badge ${urgency.color}">${urgency.label}</span>
                            </div>
                            <div class="product-actions">
                                <button class="btn-icon btn-ai" onclick="getAISuggestion(${product.id})" title="Minta Saran AI">‚ú®</button>
                                <button class="btn-icon btn-edit" onclick="editProduct(${product.id})" title="Edit">‚úèÔ∏è</button>
                                <button class="btn-icon btn-delete" onclick="deleteProduct(${product.id})" title="Hapus">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="product-details">
                            <div class="detail-item">
                                <span class="detail-label">Kategori</span>
                                <span class="detail-value">${product.category}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Jumlah</span>
                                <span class="detail-value">${product.quantity} unit</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Harga</span>
                                <span class="detail-value">Rp ${parseInt(product.price).toLocaleString("id-ID")}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Lokasi</span>
                                <span class="detail-value">${product.location}</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px; color: #666;">
                            üìÖ Expired: ${expiryDateFormatted}
                        </div>
                        ${alertMsg
                            ? `
                            <div class="alert-box ${daysLeft <= 2 ? "critical" : ""}">
                                <strong>‚ö†Ô∏è Action Required!</strong>
                                <p>${alertMsg}</p>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
                })
                .join("");
        }

        function updateStats() {
            const total = products.length;
            const critical = products.filter((p) => {
                const days = getDaysUntilExpiry(p.expiryDate);
                return days <= 2 && days >= 0;
            }).length;
            const expired = products.filter((p) => getDaysUntilExpiry(p.expiryDate) < 0).length;

            document.getElementById("totalProducts").textContent = total;
            document.getElementById("criticalProducts").textContent = critical;
            document.getElementById("expiredProducts").textContent = expired;
        }

        function getDaysUntilExpiry(expiryDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiry = new Date(expiryDate);
            expiry.setHours(0, 0, 0, 0);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        async function getAISuggestion(id) {
            if (!apiKey) {
                alert("‚ö†Ô∏è Silakan setup API Key Gemini terlebih dahulu!");
                toggleApiKey();
                return;
            }

            const product = products.find((p) => p.id === id);
            if (!product) return;

            const aiSection = document.getElementById("aiSuggestion");
            const aiContent = document.getElementById("aiContent");
            const videoContainer = document.getElementById("videoContainer");

            aiSection.classList.add("active");
            aiContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Meminta saran kepada AI...</p></div>';
            videoContainer.style.display = "none";

            window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

            const daysLeft = getDaysUntilExpiry(product.expiryDate);

            
            let contextPrompt = "";
            let actionFocus = "";

            if (daysLeft < 0) {
                
                const daysExpired = Math.abs(daysLeft);
                contextPrompt = `PENTING: Produk ini sudah EXPIRED ${daysExpired} hari yang lalu. Produk ini TIDAK BOLEH dijual atau dikonsumsi manusia.`;
                actionFocus = `Berikan 3-4 rekomendasi KHUSUS untuk produk yang sudah expired:
1. Cara pembuangan yang aman dan sesuai regulasi
2. Apakah bisa didaur ulang atau dikompos (jelaskan caranya)
3. Apakah bisa didonasikan untuk pakan ternak/hewan (jika aman dan sesuai kategori)
4. Pelajaran untuk mencegah hal serupa di masa depan
5. Dokumentasi untuk audit dan compliance

JANGAN rekomendasikan untuk dijual, dikonsumsi, atau diberikan ke manusia.`;
            } else if (daysLeft === 0) {
                
                contextPrompt = `URGENT: Produk ini akan EXPIRED HARI INI. Ini adalah kesempatan terakhir untuk mengurangi kerugian.`;
                actionFocus = `Berikan 3-4 rekomendasi URGENT untuk produk yang expired hari ini:
1. Diskon flash sale 70-90% untuk jual habis dalam beberapa jam
2. Bundle dengan produk lain (buy 1 get 1 free)
3. Donasi SEGERA ke food bank atau lembaga sosial (hubungi sebelum tutup toko)
4. Program "Pay What You Want" atau barter dengan karyawan
5. Jika memungkinkan, olah menjadi produk turunan yang tahan lama (misal: susu jadi yogurt, roti jadi bread crumbs)

Fokus pada aksi CEPAT dalam hitungan jam.`;
            } else if (daysLeft <= 2) {
                
                contextPrompt = `CRITICAL: Produk ini akan expired dalam ${daysLeft} hari. Perlu aksi cepat untuk menghindari kerugian total.`;
                actionFocus = `Berikan 3-4 rekomendasi ACTIONABLE untuk produk yang expired dalam ${daysLeft} hari:
1. Strategi diskon agresif (50-70%) dengan promosi menarik
2. Bundle deal atau paket hemat
3. Program member/loyalitas eksklusif
4. Kerjasama dengan restoran, katering, atau cafe untuk bulk purchase dengan diskon
5. Donasi terencana ke lembaga sosial sebagai CSR

Sertakan contoh konkret promosi yang bisa langsung diterapkan.`;
            } else if (daysLeft <= 5) {
                
                contextPrompt = `WARNING: Produk ini akan expired dalam ${daysLeft} hari. Masih ada waktu untuk strategi penjualan yang efektif.`;
                actionFocus = `Berikan 3-4 rekomendasi STRATEGIS untuk produk yang expired dalam ${daysLeft} hari:
1. Diskon bertahap (mulai 20-30%, naik setiap hari)
2. Promosi "Limited Time Offer" atau "Flash Deal"
3. Cross-selling dengan produk terkait
4. Marketing digital (social media, WhatsApp blast, email marketing)
5. Placement strategis di area high-traffic dengan signage menarik

Fokus pada strategi marketing yang dapat meningkatkan awareness dan penjualan.`;
            } else {
                
                contextPrompt = `INFO: Produk ini masih aman, expired dalam ${daysLeft} hari. Ini waktu yang tepat untuk perencanaan preventif.`;
                actionFocus = `Berikan 3-4 rekomendasi PREVENTIF untuk menghindari food waste:
1. Sistem inventory management: FEFO (First Expired First Out)
2. Monitoring stock dan forecasting demand lebih akurat
3. Strategi pembelian yang lebih efisien (order quantity optimal)
4. Program pre-order atau reservation untuk produk mendekati expired
5. Training staff tentang inventory rotation dan quality check

Fokus pada sistem dan prosedur untuk mencegah produk mencapai masa kritis.`;
            }

            const prompt = `Kamu adalah konsultan food waste management untuk supermarket di Indonesia.

INFORMASI PRODUK:
- Nama: ${product.name}
- Kategori: ${product.category}
- Jumlah: ${product.quantity} unit
- Harga Normal: Rp ${parseInt(product.price).toLocaleString()}
- Lokasi: ${product.location}
- Status Expired: ${daysLeft < 0 ? `Sudah expired ${Math.abs(daysLeft)} hari yang lalu` : daysLeft === 0 ? "Expired HARI INI" : `${daysLeft} hari lagi`}

${contextPrompt}

Beri jawaban rekomendasi diatas berdasarkan jurnal yang anda temukan di internet!!
Serta tidak perlu menampilkan pendahuluan dan sebagainya.

${actionFocus}

PENTING:
- Berikan rekomendasi yang SPESIFIK dan ACTIONABLE (bisa langsung diterapkan)
- Sesuaikan dengan konteks Indonesia (regulasi, budaya, market)
- Sertakan estimasi waktu implementasi jika relevan
- Gunakan format yang jelas dengan poin-poin terstruktur
- Jika ada pertimbangan hukum/kesehatan, WAJIB disebutkan

Setelah memberikan rekomendasi, berikan 3 kata kunci pencarian YouTube untuk tutorial yang relevan dengan kondisi produk ini. Format:

SEARCH KEYWORDS:
1. [Kata kunci dalam Bahasa Indonesia yang spesifik]
2. [Kata kunci dalam Bahasa Indonesia yang spesifik]
3. [Kata kunci dalam Bahasa Indonesia yang spesifik]`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemma-3-4b-it:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [{ text: prompt }],
                            },
                        ],
                    }),
                });

                const data = await response.json();

                if (data.candidates && data.candidates[0]) {
                    const fullText = data.candidates[0].content.parts[0].text;

                    const keywordRegex = /SEARCH KEYWORDS?:?\s*/i;
                    const parts = fullText.split(keywordRegex);
                    const suggestions = parts[0].trim();
                    const keywordSection = parts[1] || "";

                    
                    aiContent.innerHTML = formatAISuggestions(suggestions);

                    
                    if (keywordSection) {
                        
                        const lines = keywordSection.split("\n");
                        const keywords = [];

                        for (let line of lines) {
                            line = line.trim();
                            
                            const match = line.match(/^[\d\-\*\‚Ä¢]+[\.\):]?\s*(.+)$/);
                            if (match && match[1]) {
                                let keyword = match[1].trim();
                                
                                keyword = keyword.replace(/^["'\[\(]+|["'\]\)]+$/g, "");
                                if (keyword.length > 5) {
                                    
                                    keywords.push(keyword);
                                }
                            }
                        }

                        
                        if (keywords.length === 0) {
                            const daysLeft = getDaysUntilExpiry(product.expiryDate);
                            if (daysLeft < 0) {
                                keywords.push(`cara buang ${product.category} expired dengan aman`);
                                keywords.push(`kompos dari ${product.category}`);
                                keywords.push(`food waste management Indonesia`);
                            } else if (daysLeft <= 2) {
                                keywords.push(`cara jual ${product.category} hampir expired`);
                                keywords.push(`diskon flash sale supermarket`);
                                keywords.push(`food rescue Indonesia`);
                            } else {
                                keywords.push(`mengurangi food waste ${product.category}`);
                                keywords.push(`strategi penjualan makanan mendekati expired`);
                                keywords.push(`inventory management supermarket`);
                            }
                        }

                        displayVideoLinks(keywords.slice(0, 3)); 
                    } else {
                        
                        const daysLeft = getDaysUntilExpiry(product.expiryDate);
                        const defaultKeywords = [];
                        if (daysLeft < 0) {
                            defaultKeywords.push(`cara buang ${product.category} expired dengan aman`);
                            defaultKeywords.push(`kompos dari ${product.category}`);
                            defaultKeywords.push(`food waste management Indonesia`);
                        } else if (daysLeft <= 2) {
                            defaultKeywords.push(`cara jual ${product.category} hampir expired`);
                            defaultKeywords.push(`diskon flash sale supermarket`);
                            defaultKeywords.push(`food rescue Indonesia`);
                        } else {
                            defaultKeywords.push(`mengurangi food waste ${product.category}`);
                            defaultKeywords.push(`strategi penjualan makanan mendekati expired`);
                            defaultKeywords.push(`inventory management supermarket`);
                        }
                        displayVideoLinks(defaultKeywords);
                    }
                } else if (data.error) {
                    aiContent.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${data.error.message}</p><p>Periksa API Key Anda atau pastikan API sudah aktif.</p>`;
                } else {
                    aiContent.innerHTML = '<p style="color: #ef4444;">‚ùå Gagal mendapatkan saran. Periksa API Key Anda.</p>';
                }
            } catch (error) {
                aiContent.innerHTML = `<p style="color: #ef4444;">‚ùå Error: ${error.message}</p><p>Pastikan koneksi internet Anda stabil.</p>`;
            }
        }

        function formatAISuggestions(text) {
            
            text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

            
            text = text.replace(/\*([^*]+?)\*/g, "<em>$1</em>");

            
            let formatted = text;

            
            const lines = formatted.split("\n");
            let html = "";
            let inRecommendation = false;
            let recommendationItems = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                
                if (line.includes("Rekomendasi:") || line.includes("rekomendasi:")) {
                    if (recommendationItems.length > 0) {
                        html += '<div class="ai-recommendation">';
                        recommendationItems.forEach((item) => {
                            html += `<div class="ai-recommendation-item">${item}</div>`;
                        });
                        html += "</div>";
                        recommendationItems = [];
                    }
                    html += `<h3>üí° ${line.replace(/\*\*/g, "")}</h3>`;
                    inRecommendation = true;
                }
                
                else if (line.match(/^[\*\-\‚Ä¢]\s+/) || line.match(/^\d+\.\s+/)) {
                    const cleanLine = line.replace(/^[\*\-\‚Ä¢]\s+/, "").replace(/^\d+\.\s+/, "");
                    if (inRecommendation) {
                        recommendationItems.push(cleanLine);
                    } else {
                        html += `<div class="ai-recommendation-item">${cleanLine}</div>`;
                    }
                }
                
                else if (line.length > 0) {
                    if (recommendationItems.length > 0) {
                        html += '<div class="ai-recommendation">';
                        recommendationItems.forEach((item) => {
                            html += `<div class="ai-recommendation-item">${item}</div>`;
                        });
                        html += "</div>";
                        recommendationItems = [];
                        inRecommendation = false;
                    }
                    html += `<p>${line}</p>`;
                }
                
                else {
                    if (recommendationItems.length > 0) {
                        html += '<div class="ai-recommendation">';
                        recommendationItems.forEach((item) => {
                            html += `<div class="ai-recommendation-item">${item}</div>`;
                        });
                        html += "</div>";
                        recommendationItems = [];
                        inRecommendation = false;
                    }
                }
            }

            
            if (recommendationItems.length > 0) {
                html += '<div class="ai-recommendation">';
                recommendationItems.forEach((item) => {
                    html += `<div class="ai-recommendation-item">${item}</div>`;
                });
                html += "</div>";
            }

            return html || text;
        }
        function displayVideoLinks(keywords) {
            const videoContainer = document.getElementById("videoContainer");
            const videoLinks = document.getElementById("videoLinks");

            videoLinks.innerHTML = keywords
                .map((keyword, index) => {
                    const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(keyword)}`;
                    return `
                    <div class="video-link-card">
                        <a href="${searchUrl}" target="_blank">
                            <div class="video-icon">üé¨</div>
                            <span>${keyword}</span>
                            <span class="video-arrow">‚Üí</span>
                        </a>
                    </div>
                `;
                })
                .join("");

            videoContainer.style.display = "block";
        }

        init();
    </script>
</body>

</html>
